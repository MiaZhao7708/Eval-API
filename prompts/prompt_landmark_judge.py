import re, json, copy
import random

# 判断不准确
PROMPT_LANDMARK_JUDGE_V1 = """
    You are given 5 responses generated by a Visual-Language Model (VLLM) to the question "Where was this image taken?". Each response should be compared with the provided correct answer, which includes the exact name of the landmark.
 
    Your task is to evaluate the overall recognition of the landmark based on all 5 responses together, and assign a confidence level on a scale of 1 to 5:

    1 - All 5 responses do not match the correct answer at all.
    2 - The responses contain some relevant information but do not accurately identify the landmark.
    3 - The responses partially match the correct answer but lack key details or precision.
    4 - The responses are mostly correct, accurately identifying the landmark with minor inaccuracies or missing details.
    5 - All 5 responses correctly and confidently identify the landmark with detailed and specific information.
    
    Please provide your evaluation in the following JSON format:
    {
        "rate": <confidence_level>,
        "explanation": "<brief_explanation>"
    }
    The correct answer is: "{correct_answer}"

    Here are the responses:
    """


PROMPT_LANDMARK_JUDGE_V2 = """
    You are given 5 responses generated by a Visual-Language Model (VLLM) to the question "Where was this image taken?". Each response should be compared with the provided correct answer, which includes the exact name of the landmark.

    Your task is to evaluate the overall recognition of the landmark based on all 5 responses together, and classify the recognition into one of the following four levels:

    - "Strongly Known": The responses correctly identify the landmark multiple times, providing detailed and accurate information that matches the correct answer.
    - "Known": At least one response correctly identifies the landmark and provides a reasonable explanation.
    - "Partially Known": None of the responses correctly name the landmark, but some responses contain relevant details, such as geographical hints, architectural styles, or historical references, that are associated with or suggest a connection to the correct landmark. However, responses that merely describe the image's general features without mentioning any landmark should not be classified as Partially Known.
    - "Unknown": None of the responses correctly identify the landmark, and the information provided is either unrelated or significantly off the mark. If the responses only describe general features of the image without mentioning any landmark, or if mentioned landmarks are irrelevant, the recognition should be classified as Unknown.

    Please provide your evaluation in the following JSON format:
    {
        "rate": "<level_of_recognition>",
        "explanation": "<brief_explanation_based_on_the_criteria>"
    }

    The correct answer is: "{correct_answer}"

    Here are the responses:
    """

# V2中——>没有提到地标，只有大致类别的分类不准确
PROMPT_LANDMARK_JUDGE = """
    You are given 5 responses generated by a Visual-Language Model (VLLM) to the question "Where was this image taken?". Each response should be compared with the provided correct answer, which includes the exact name of the landmark.

    Your task is to evaluate the overall recognition of the landmark based on all 5 responses together, and classify the recognition into one of the following four levels:

    - "Strongly Known": The responses correctly identify the landmark multiple times, providing detailed and accurate information that matches the correct answer.
    - "Known": At least one response correctly identifies the landmark and provides a reasonable explanation.
    - "Partially Known": The responses do not identify the correct landmark but mention other landmarks with relevant details, such as geographical hints, architectural styles, or historical references, that are associated with or suggest a connection to the correct landmark. However, responses that only mention broad categories, such as “church” or “park,” without referencing specific landmarks, should not be classified as Partially Known.
    - "Unknown": None of the responses correctly identify the landmark, and the information provided is either unrelated or significantly off the mark. If the responses only describe general features of the image without mentioning any landmark, or if mentioned landmarks are irrelevant, the recognition should be classified as Unknown.
        
    Please provide your evaluation in the following JSON format:
    {
        "rate": "<level_of_recognition>",
        "explanation": "<brief_explanation_based_on_the_criteria>"
    }

    The correct answer is: "{correct_answer}"

    Here are the responses:
    """

def get_prompt(vlm_responses):
    correct_answer = vlm_responses[0]['label']
    judger_prompt = PROMPT_LANDMARK_JUDGE.replace('{correct_answer}', correct_answer)
    
    for i, response in enumerate(vlm_responses, 1):
        judger_prompt += f"\nResponse {i}: {response['text']}"
    
    judger_prompt += "\n\nPlease provide your classification and a brief explanation based on the criteria above."
    
    return judger_prompt



def parse(item, response):
    if response is not None:
        output = json.loads(response['text'])
        response['text'] = output
        response['question_id'] = item['question_id']
        response['image'] = item['image']
        response['label'] = item['label']
    return response